<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.centerm.fud_demo.dao.FileDao">
    <parameterMap id="FileRecord" type="com.centerm.fud_demo.entity.FileRecord"/>
    <parameterMap id="DownloadRecord" type="com.centerm.fud_demo.entity.DownloadRecord"/>
    <select id="getAllFileByUsername" parameterType="string" resultType="com.centerm.fud_demo.entity.FileRecord">
      SELECT fud.file.id,fud.file.name,fud.file.suffix,fud.file.size,fud.file.download_times,fud.file.create_time
      FROM file
      WHERE fud.file.user_id=
      (SELECT fud.user.id
        FROM fud.user
        WHERE fud.user.username=#{username})
    </select>
    <insert id="addFile" parameterMap="FileRecord">
        INSERT INTO file(name, local_url, size, user_id, md5, suffix, create_time)
        VALUES(#{name}, #{local_url}, #{size}, #{user_id}, #{md5}, #{suffix}, #{create_time})
    </insert>
    <insert id="addDownloadRecord" parameterMap="DownloadRecord">
        INSERT INTO download(create_time, user_id, file_id)
        VALUES (#{create_time}, #{user_id}, #{file_id})
    </insert>
    <select id="getFileById" parameterType="long" resultType="com.centerm.fud_demo.entity.FileRecord">
        SELECT fud.file.id, fud.file.name,fud.file.local_url, fud.file.create_time from fud.file
        WHERE id = #{id}
    </select>
    <select id="getAllFile" resultType="com.centerm.fud_demo.entity.FileRecord">
        SELECT fud.file.*
        FROM fud.file
    </select>
    <select id="getDownloadNumbers" resultType="java.lang.Integer">
        SELECT fud.download.file_id,count(*) AS count
        FROM fud.download
        GROUP BY
          fud.download.file_id
        ORDER BY
          COUNT DESC
    </select>
    <select id="getMostDownloadRecord" resultType="com.centerm.fud_demo.entity.FileRecord">
        SELECT fud.file.name, fud.file.size, fud.file.download_times, fud.file.suffix, fud.file.create_time
        FROM file
        ORDER BY download_times DESC
        LIMIT 0,5
    </select>
    <select id="getDownloadTimesByUserId" parameterType="long" resultType="java.lang.Long">
        SELECT SUM(fud.file.download_times)
        FROM file
        WHERE fud.file.user_id = #{userId}
    </select>
    <select id="getDownloadTimes" resultType="java.lang.Long">
        SELECT SUM(fud.file.download_times)
        FROM file
    </select>
    <select id="getUploadTimes" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM file
    </select>
</mapper>